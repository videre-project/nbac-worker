name: Build
on:
  workflow_dispatch:
  schedule:
    # Run 3 times a day, centered around internet peak hours:
    # - 9:00 UTC (morning), 15:00 UTC (afternoon), 21:00 UTC (evening)
    - cron: '0 9,15,21 * * *'
concurrency:
  group: ci-${{ github.workflow }}
  cancel-in-progress: true
env:
  CI_PYTHON_VERSION: "3.13"
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Check out the repository
      - uses: actions/checkout@v4
        with:
          show-progress: false
      # Install project dependencies
      - name: Install uv
        uses: astral-sh/setup-uv@v4
      - name: Set up Python
        run: uv python install ${{ env.CI_PYTHON_VERSION }}
      - name: Create virtual environment
        run: |
          uv venv --python ${{ env.CI_PYTHON_VERSION }} .venv
          echo "$PWD/.venv/bin" >> $GITHUB_PATH
      # Setup Cloudflare Tunnel
      - name: Install cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared
          cloudflared --version
      - name: Start Cloudflare Tunnel
        run: |
          cloudflared access tcp --hostname db1.videreproject.com --url localhost:5433 &
          echo "Tunnel started in background"
          
          # Wait for the port to be ready
          timeout 30 sh -c 'until nc -z localhost 5433; do sleep 1; done'
          echo "Tunnel is ready"
        env:
          CF_CLIENT_ID: ${{ secrets.CF_CLIENT_ID }}
          CF_CLIENT_SECRET: ${{ secrets.CF_CLIENT_SECRET }}
      # Run the build script
      - name: Create .env file
        run: |
          # Use the local tunnel port (5433) to proxy a connection
          echo "DATABASE_URL=postgresql://api:${{ secrets.DB_PASSWORD }}@localhost:5433/mtgo?sslmode=disable" >> .env
          echo "CLOUDFLARE_EMAIL=${{ secrets.CLOUDFLARE_EMAIL }}" >> .env
          echo "CLOUDFLARE_API_KEY=${{ secrets.CLOUDFLARE_API_KEY }}" >> .env
          echo "CLOUDFLARE_DATABASE_ID=${{ secrets.CLOUDFLARE_DATABASE_ID }}" >> .env
          echo "CLOUDFLARE_ACCOUNT_ID=${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" >> .env
      - name: Build
        run: |
          set -e
          source .venv/bin/activate
          uv run build.py
  keepalive:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      # Ensure that the cron job keeps running (even if the repo is inactive).
      - uses: liskin/gh-workflow-keepalive@v1
